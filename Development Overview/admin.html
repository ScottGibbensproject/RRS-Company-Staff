<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Development Overview - Admin</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-container">
  <header class="admin-header">
    <h1>Development Overview - Admin</h1>
    <a href="index.html" class="btn btn-secondary">View Public Page</a>
  </header>

  <!-- Section Tabs -->
  <div class="tabs">
    <button class="tab active" data-section="changelog">Changelog</button>
    <button class="tab" data-section="inProgress">In Progress</button>
    <button class="tab" data-section="upcoming">Upcoming</button>
    <button class="tab" data-section="knownIssues">Known Issues</button>
  </div>

  <div class="admin-layout">
    <!-- Left: Form & Entry List -->
    <div>
      <div class="form-section">
        <h2 id="form-title">Add New Entry</h2>
        <form id="update-form">
          <input type="hidden" id="edit-id">
          <input type="hidden" id="current-section" value="changelog">

          <div class="form-group" id="date-group">
            <label for="update-date" id="date-label">Date</label>
            <input type="date" id="update-date">
          </div>

          <div class="form-group" id="status-group" style="display: none;">
            <label for="issue-status">Status</label>
            <select id="issue-status">
              <option value="researching">Researching</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>

          <div class="form-group" id="resolved-date-group" style="display: none;">
            <label for="resolved-date">Date Resolved</label>
            <input type="date" id="resolved-date">
          </div>

          <div class="form-group">
            <label for="update-title">Title</label>
            <input type="text" id="update-title" placeholder="e.g., Dashboard Redesign" required>
          </div>

          <div class="form-group">
            <label for="update-description">Description</label>
            <textarea id="update-description" placeholder="Describe the update..." required></textarea>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-primary" id="submit-btn">Add Entry</button>
            <button type="button" class="btn btn-secondary" id="cancel-btn" style="display: none;">Cancel</button>
          </div>
        </form>
      </div>

      <!-- Entry List -->
      <div class="form-section" style="margin-top: 1rem;">
        <h2 id="list-title">Changelog Entries</h2>
        <div class="entry-list" id="entry-list"></div>
      </div>

      <!-- Export Section -->
      <div class="form-section" style="margin-top: 1rem;">
        <div class="export-section" style="border: none; padding-top: 0; margin-top: 0;">
          <h3>Export JSON</h3>
          <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 0.75rem;">
            Copy this JSON and paste it into <code>data.json</code> before deploying to Netlify.
          </p>
          <textarea class="export-textarea" id="export-json" readonly></textarea>
          <div class="btn-group">
            <button type="button" class="btn btn-secondary" id="copy-btn">Copy JSON</button>
            <button type="button" class="btn btn-secondary" id="import-btn">Import JSON</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Preview -->
    <div class="form-section preview-section">
      <h2>Preview</h2>
      <div id="preview-content"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="app.js"></script>
  <script>
    // State
    let data = {
      changelog: [],
      inProgress: [],
      upcoming: [],
      knownIssues: []
    };
    let currentSection = 'changelog';
    let editingId = null;

    // Elements
    const form = document.getElementById('update-form');
    const formTitle = document.getElementById('form-title');
    const listTitle = document.getElementById('list-title');
    const currentSectionInput = document.getElementById('current-section');
    const dateGroup = document.getElementById('date-group');
    const dateLabel = document.getElementById('date-label');
    const dateInput = document.getElementById('update-date');
    const statusGroup = document.getElementById('status-group');
    const statusInput = document.getElementById('issue-status');
    const resolvedDateGroup = document.getElementById('resolved-date-group');
    const resolvedDateInput = document.getElementById('resolved-date');
    const titleInput = document.getElementById('update-title');
    const descriptionInput = document.getElementById('update-description');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const entryList = document.getElementById('entry-list');
    const previewContent = document.getElementById('preview-content');
    const exportJson = document.getElementById('export-json');
    const copyBtn = document.getElementById('copy-btn');
    const importBtn = document.getElementById('import-btn');
    const toast = document.getElementById('toast');

    const sectionLabels = {
      changelog: 'Changelog',
      inProgress: 'In Progress',
      upcoming: 'Upcoming Features',
      knownIssues: 'Known Issues'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      dateInput.valueAsDate = new Date();

      // Try to load from data.json first, then fall back to localStorage
      try {
        const response = await fetch('data.json');
        if (response.ok) {
          const jsonData = await response.json();
          if (jsonData.changelog && jsonData.inProgress && jsonData.upcoming) {
            data = jsonData;
            // Ensure knownIssues exists
            if (!data.knownIssues) data.knownIssues = [];
            // Sync to localStorage
            localStorage.setItem('dev-overview-data', JSON.stringify(data));
            showToast('Loaded from data.json');
          }
        }
      } catch (e) {
        // Fetch failed (likely file:// protocol), try localStorage
        const saved = localStorage.getItem('dev-overview-data');
        if (saved) {
          data = JSON.parse(saved);
          // Ensure knownIssues exists
          if (!data.knownIssues) data.knownIssues = [];
        }
      }

      renderAll();
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        currentSection = tab.dataset.section;
        currentSectionInput.value = currentSection;

        // Show/hide date field and update label
        if (currentSection === 'changelog') {
          dateGroup.style.display = 'block';
          dateLabel.textContent = 'Date';
          statusGroup.style.display = 'none';
          resolvedDateGroup.style.display = 'none';
        } else if (currentSection === 'inProgress' || currentSection === 'upcoming') {
          dateGroup.style.display = 'block';
          dateLabel.textContent = 'Estimated Deployment Date';
          statusGroup.style.display = 'none';
          resolvedDateGroup.style.display = 'none';
        } else if (currentSection === 'knownIssues') {
          dateGroup.style.display = 'block';
          dateLabel.textContent = 'Date Reported';
          statusGroup.style.display = 'block';
          // Show resolved date only if status is resolved
          resolvedDateGroup.style.display = statusInput.value === 'resolved' ? 'block' : 'none';
        } else {
          dateGroup.style.display = 'none';
          statusGroup.style.display = 'none';
          resolvedDateGroup.style.display = 'none';
        }

        // Update labels
        listTitle.textContent = sectionLabels[currentSection] + ' Entries';

        resetForm();
        renderAll();
      });
    });

    // Status change listener for Known Issues
    statusInput.addEventListener('change', () => {
      if (currentSection === 'knownIssues') {
        resolvedDateGroup.style.display = statusInput.value === 'resolved' ? 'block' : 'none';
        if (statusInput.value === 'resolved' && !resolvedDateInput.value) {
          resolvedDateInput.valueAsDate = new Date();
        }
      }
    });

    // Form Submit
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const entry = {
        id: editingId || Date.now().toString(),
        title: titleInput.value,
        description: descriptionInput.value
      };

      // Add date for changelog, estimatedDate for inProgress and upcoming
      if (currentSection === 'changelog') {
        entry.date = dateInput.value;
      } else if ((currentSection === 'inProgress' || currentSection === 'upcoming') && dateInput.value) {
        entry.estimatedDate = dateInput.value;
      } else if (currentSection === 'knownIssues') {
        entry.dateReported = dateInput.value;
        entry.status = statusInput.value;
        if (statusInput.value === 'resolved' && resolvedDateInput.value) {
          entry.dateResolved = resolvedDateInput.value;
        }
      }

      if (editingId) {
        const index = data[currentSection].findIndex(u => u.id === editingId);
        if (index !== -1) {
          data[currentSection][index] = entry;
        }
        showToast('Entry saved');
      } else {
        data[currentSection].push(entry);
        showToast('Entry added');
      }

      saveAndRender();
      resetForm();
    });

    // Cancel Edit
    cancelBtn.addEventListener('click', resetForm);

    // Copy JSON
    copyBtn.addEventListener('click', () => {
      exportJson.select();
      document.execCommand('copy');
      showToast('JSON copied to clipboard');
    });

    // Import JSON
    importBtn.addEventListener('click', () => {
      const json = prompt('Paste your JSON data:');
      if (json) {
        try {
          const imported = JSON.parse(json);
          if (imported.changelog && imported.inProgress && imported.upcoming) {
            data = imported;
            // Ensure knownIssues exists
            if (!data.knownIssues) data.knownIssues = [];
            saveAndRender();
            showToast('Data imported successfully');
          } else {
            alert('Invalid format. Expected object with changelog, inProgress, and upcoming arrays.');
          }
        } catch (e) {
          alert('Invalid JSON. Please check the format.');
        }
      }
    });

    // Edit Entry
    function editEntry(id) {
      const entry = data[currentSection].find(u => u.id === id);
      if (!entry) return;

      editingId = id;
      if (currentSection === 'changelog' && entry.date) {
        dateInput.value = entry.date;
      } else if ((currentSection === 'inProgress' || currentSection === 'upcoming') && entry.estimatedDate) {
        dateInput.value = entry.estimatedDate;
      } else if (currentSection === 'knownIssues') {
        if (entry.dateReported) dateInput.value = entry.dateReported;
        if (entry.status) {
          statusInput.value = entry.status;
          resolvedDateGroup.style.display = entry.status === 'resolved' ? 'block' : 'none';
        }
        if (entry.dateResolved) resolvedDateInput.value = entry.dateResolved;
      }
      titleInput.value = entry.title;
      descriptionInput.value = entry.description;

      formTitle.textContent = 'Edit Entry';
      submitBtn.textContent = 'Save Changes';
      cancelBtn.style.display = 'inline-flex';

      form.scrollIntoView({ behavior: 'smooth' });
    }

    // Delete Entry
    function deleteEntry(id) {
      if (confirm('Are you sure you want to delete this entry?')) {
        data[currentSection] = data[currentSection].filter(u => u.id !== id);
        saveAndRender();
        showToast('Entry deleted');

        if (editingId === id) {
          resetForm();
        }
      }
    }

    // Reset Form
    function resetForm() {
      editingId = null;
      form.reset();
      dateInput.valueAsDate = new Date();
      statusInput.value = 'researching';
      resolvedDateInput.value = '';
      if (currentSection === 'knownIssues') {
        resolvedDateGroup.style.display = 'none';
      }
      formTitle.textContent = 'Add New Entry';
      submitBtn.textContent = 'Add Entry';
      cancelBtn.style.display = 'none';
    }

    // Save and Render
    function saveAndRender() {
      localStorage.setItem('dev-overview-data', JSON.stringify(data));
      renderAll();
    }

    // Render All
    function renderAll() {
      const items = data[currentSection] || [];

      // Sort based on section
      let sorted = [...items];
      if (currentSection === 'changelog') {
        sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
      } else if (currentSection === 'knownIssues') {
        sorted.sort((a, b) => new Date(b.dateReported) - new Date(a.dateReported));
      }

      // Render entry list
      if (sorted.length === 0) {
        entryList.innerHTML = '<div class="empty-state"><p>No entries yet. Add one above.</p></div>';
      } else {
        entryList.innerHTML = sorted.map(entry => {
          let dateHtml = '';
          let statusHtml = '';
          if (entry.date) {
            dateHtml = `<div class="entry-item-date">${formatDate(entry.date)}</div>`;
          } else if (entry.estimatedDate) {
            dateHtml = `<div class="entry-item-date">Est: ${formatDate(entry.estimatedDate)}</div>`;
          } else if (entry.dateReported) {
            dateHtml = `<div class="entry-item-date">Reported: ${formatDate(entry.dateReported)}</div>`;
            if (entry.status) {
              const statusClass = entry.status === 'resolved' ? 'color: #10b981;' : 'color: #f59e0b;';
              statusHtml = `<div class="entry-item-date" style="${statusClass}">${entry.status === 'resolved' ? 'Resolved' : 'Researching'}</div>`;
            }
          }
          return `
            <div class="entry-item">
              <div class="entry-item-header">
                <div>
                  ${dateHtml}
                  ${statusHtml}
                  <div class="entry-item-title">${escapeHtml(entry.title)}</div>
                </div>
                <div class="entry-actions">
                  <button class="btn btn-secondary btn-small" onclick="editEntry('${entry.id}')">Edit</button>
                  <button class="btn btn-danger btn-small" onclick="deleteEntry('${entry.id}')">Delete</button>
                </div>
              </div>
              <div class="entry-item-description">${escapeHtml(entry.description)}</div>
            </div>
          `;
        }).join('');
      }

      // Render preview
      if (sorted.length === 0) {
        previewContent.innerHTML = '<div class="empty-state"><p>Preview will appear here.</p></div>';
      } else {
        if (currentSection === 'changelog') {
          previewContent.innerHTML = '<div class="timeline">' + sorted.map(entry => renderChangelogEntry(entry)).join('') + '</div>';
        } else if (currentSection === 'knownIssues') {
          previewContent.innerHTML = sorted.map(entry => renderIssueCard(entry)).join('');
        } else {
          const type = currentSection === 'inProgress' ? 'in-progress' : 'upcoming';
          previewContent.innerHTML = sorted.map(entry => renderFeatureCard(entry, type)).join('');
        }
      }

      // Update export JSON (full data)
      exportJson.value = JSON.stringify(data, null, 2);
    }

    // Toast
    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
